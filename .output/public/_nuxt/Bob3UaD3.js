import{a as oe,M as ie,g as G,Q as X,b as le,S as se,P as ce,W as ue,O as de,A as me,D as he,h as Z,E as pe,f as ge,j as fe,e as we,i as Se}from"./GFrmpgK8.js";import{r as O,o as ve,I as ye,t as K,x as $,N as Me,K as Y,O as Te,v as j}from"./B_MDMm1d.js";const xe={class:"splash-container"},Pe=["disabled"],ee=50,te=20,De={__name:"ver3-2",setup(ke){const R=O(null),C=O(!0),P=O(!1),H=O(!1),W=O(!1);let m,h,M,k,l,u,A,L,V,d=[],f=[],v=[],p=[],E=[],z=null,F=null,y=null,b=null,B=null,_=!1,g="idle",q=null;const o={centerBall:{maxStrength:1,minStrength:0,fadeDuration:5,fadeEasing:{type:"easeIn",power:.5}},timing:{baseShrinkDuration:3,flowShrinkDurationFactor:.2},growth:{speed:5,easeOutPower:.15,flowSpeedFactor:.1},wave:{frequency:1,amplitudeFactor:.3,phaseFactor:Math.PI*4},renderer:{pixelRatio:1.5,antialias:!0,alpha:!0},camera:{fov:45,near:.1,far:1e3,position:{x:0,y:0,z:25}},controls:{enableDamping:!0,autoRotateSpeed:5,enablePan:!1,enableZoom:!1}},w={material:{generate(){return new fe({color:16777215,metalness:0,roughness:0,transparent:!0,opacity:.75,transmission:1,ior:1.33,thickness:1,envMap:null,envMapIntensity:50,side:we})},loadEnvironmentMap(){return new Promise((e,a)=>{new pe().setPath("/hdr/").load("HDR_Light_Studio_Free_HDRI_Design_04.exr",t=>{t.mapping=ge;const n=L.fromEquirectangular(t).texture;L.dispose(),t.dispose(),console.log("本地 EXR 環境貼圖已載入並處理完成。"),m.environment=n,A&&(A.envMap=n,A.needsUpdate=!0),e(n)},void 0,t=>{console.error("無法載入本地 EXR 環境貼圖:",t),a(t)})})}},line:{updateMetaball(e){if(!u)return;e.reset();const a=u.getElapsedTime(),t=new G(.5,.5,.5),n=p.length;if(P.value&&w.flow.updateGlobalState(a),_){const s=w.ball.calculateCenterStrength(a);s>.01&&e.addBall(t.x,t.y,t.z,s,te)}if(!W.value){e.update();return}for(let s=0;s<n;s++){if(d[s]===void 0||a<d[s]||v[s]===void 0)continue;const r=v[s]/e.scale.x;let i=0,S=a-d[s];if(P.value){switch(g){case"growing":if(r>.001){const x=o.growth.speed*o.growth.flowSpeedFactor,D=r/(x/e.scale.x),Q=D>0?Math.min(S/D,1):1;i=Math.pow(Q,o.growth.easeOutPower)*r}else i=0;break;case"pauseAtEnd":i=r;break;case"shrinking":if(y!==null&&b!==null){const x=b-y,D=a-y,Q=Math.min(D/x,1),I=Math.max(0,1-Q);i=r*I}else i=r;break;case"pauseAtStart":i=.001;break;default:i=0;break}E[s]=g}else if(r>.001){const x=Math.min(S/(r/(o.growth.speed/e.scale.x)),1);i=Math.pow(x,o.growth.easeOutPower)*r}else i=0;if(i<=.001)continue;const c=f[s],T=p[s];if(!(!c||!T))for(let x=0;x<=ee;x++){const D=x/ee,Q=Math.pow(D,T==="tt"?.25:1.25),I=Z.lerp(T==="tt"?.1:.01,T==="tt"?.01:.1,Q);let U=I;if(P.value){const ae=o.wave.amplitudeFactor*I,re=Math.sin(a*o.wave.frequency-D*o.wave.phaseFactor)*ae;U+=re,U=Math.max(U,0)}const N=c.clone().multiplyScalar(i*D).add(t);e.addBall(N.x,N.y,N.z,U,te)}}e.update()},loadModelJson(){fetch("/modelJson.json").then(e=>e.json()).then(e=>{console.log("讀取的設定:",e);const a=e.lineTypes.length;d=new Array(a),f=new Array(a),v=new Array(a),p=new Array(a),E=new Array(a);const t=(u==null?void 0:u.getElapsedTime())??0;for(let n=0;n<a;n++)p[n]=e.lineTypes[n],v[n]=e.currentTargetLengths[n],e.randomDirections[n]?f[n]=new G(e.randomDirections[n].x,e.randomDirections[n].y,e.randomDirections[n].z):f[n]=null,d[n]=t-1e3,E[n]="growing";if(l&&e.cameraQuaternion){const n=new X(e.cameraQuaternion.x,e.cameraQuaternion.y,e.cameraQuaternion.z,e.cameraQuaternion.w);l.quaternion.set(0,0,0,1);const s=n.clone().invert();l.quaternion.premultiply(s),l.matrixWorldNeedsUpdate=!0,l.updateMatrixWorld(!0),l.matrixAutoUpdate=!1}console.log("模型設定已載入完成")}).catch(e=>{console.error("載入模型設定失敗:",e)})}},ball:{calculateCenterStrength(e){if(!u||(e===void 0&&(e=u.getElapsedTime()),!W.value))return .8;if(g==="shrinking"){if(y===null||b===null)return 0;const a=b-y,t=e-y,n=Math.min(t/a,1);return o.centerBall.minStrength+n*(o.centerBall.maxStrength-o.centerBall.minStrength)}else if(g==="pauseAtStart"){if(q===null)return q=e,o.centerBall.maxStrength;const a=e-q,t=Math.min(a/o.centerBall.fadeDuration,1);let n;switch(o.centerBall.fadeEasing.type){case"easeIn":n=Math.pow(t,o.centerBall.fadeEasing.power);break;case"easeOut":n=1-Math.pow(1-t,o.centerBall.fadeEasing.power);break;case"linear":default:n=t;break}return o.centerBall.maxStrength*(1-n)}else return o.centerBall.minStrength}},flow:{calculateCurrentLength(e,a,t,n,s){switch(e){case"growing":if(a>.001){const r=o.growth.speed*o.growth.flowSpeedFactor,i=a/(r/n),S=i>0?Math.min(t/i,1):1;return Math.pow(S,o.growth.easeOutPower)*a}return 0;case"pauseAtEnd":return a;case"shrinking":if(y!==null&&b!==null){const r=u.getElapsedTime(),i=b-y,S=r-y,c=Math.min(S/i,1),T=Math.max(0,1-c);return a*T}return a;case"pauseAtStart":return .001;default:return 0}},updateGlobalState(e){if(!(!P.value||!u))if(g==="growing"&&B!==null){const a=p.length;let t=0,n=0;for(let r=0;r<a;r++){if(d[r]===void 0||v[r]===void 0)continue;n++;const i=v[r]/((l==null?void 0:l.scale.x)||1),S=e-(d[r]||e),c=o.growth.speed*o.growth.flowSpeedFactor,T=i/(c/((l==null?void 0:l.scale.x)||1)),x=T>0?Math.min(S/T,1):1;t+=x}(n>0?t/n:0)>=.99&&(g="pauseAtEnd",console.log("所有線條已生長完成，進入暫停狀態"),setTimeout(()=>{P.value&&w.flow.startShrinking()},1e3))}else g==="shrinking"&&y!==null&&b!==null&&e>=b&&(g="pauseAtStart",console.log("所有線條已收合完成，進入起始暫停狀態"),setTimeout(()=>{P.value&&w.flow.startGrowing()},1e3))},startShrinking(){if(!u)return;const e=u.getElapsedTime();console.log("所有線條同步收合"),g="shrinking",y=e,b=e+o.timing.baseShrinkDuration*o.timing.flowShrinkDurationFactor,_=!0},startGrowing(){var t;if(!u)return;const e=u.getElapsedTime(),a=p.length;console.log("所有線條同步生長"),g="growing",B=e,_=!1,q=null;for(let n=0;n<a;n++){if(d[n]===void 0)continue;f[n]||(f[n]=new G),(t=f[n])==null||t.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize();const s=2,r=3.5;v[n]=Z.randFloat(s,r),d[n]=e}},toggle(){if(!(!u||!l||!h||!k)){if(P.value)P.value=!1,g="idle",y=null,b=null,B=null,_=!1,console.log("流動動畫已停止，正在恢復狀態..."),z?(p=[...z.lineTypes],f=z.randomDirections.map(e=>e?new G(e.x,e.y,e.z):null),v=[...z.currentTargetLengths],d=[...z.lineStartTimes],E=p.map(()=>"growing"),console.log("線條狀態已恢復"),z=null):console.warn("找不到保存的狀態來恢復。"),F?(h.position.copy(F.position),h.quaternion.copy(F.quaternion),k.update(),console.log("相機狀態已恢復"),F=null):console.warn("找不到保存的相機狀態來恢復。"),l.reset();else{console.log("開始流動動畫，正在保存當前狀態..."),z={lineTypes:[...p],randomDirections:f.map(t=>t?{x:t.x,y:t.y,z:t.z}:null),currentTargetLengths:[...v],lineStartTimes:[...d]},F={position:h.position.clone(),quaternion:h.quaternion.clone()},console.log("狀態已保存。"),P.value=!0,g="growing",B=u.getElapsedTime();const e=u.getElapsedTime(),a=p.length;E.length=a,console.log("所有線條同時開始生長。");for(let t=0;t<a;t++)d[t]=e,E[t]="growing";l.reset()}l.material=A}},initializeState(){if(!u)return;console.log("初始化流動動畫狀態...");const e=u.getElapsedTime();z={lineTypes:[...p],randomDirections:f.map(t=>t?{x:t.x,y:t.y,z:t.z}:null),currentTargetLengths:[...v],lineStartTimes:[...d]},F={position:h.position.clone(),quaternion:h.quaternion.clone()},g="growing",B=e;const a=p.length;E.length=a;for(let t=0;t<a;t++)d[t]=e,E[t]="growing";l.reset(),l.material=A,console.log("流動動畫已初始化完成")}},scene:{initialize(){if(!R.value)return console.error("Canvas container not found!"),null;const e=R.value,a=e.clientWidth,t=e.clientHeight,n=new se;n.background=null;const s=new ce(o.camera.fov,a/t,o.camera.near,o.camera.far);s.position.set(o.camera.position.x,o.camera.position.y,o.camera.position.z),s.lookAt(0,0,0);const r=new ue({antialias:o.renderer.antialias,alpha:o.renderer.alpha});r.setSize(a,t),r.setPixelRatio(Math.min(window.devicePixelRatio,o.renderer.pixelRatio)),e.appendChild(r.domElement);const i=new de(s,r.domElement);i.enableDamping=o.controls.enableDamping,i.autoRotate=C.value,i.autoRotateSpeed=o.controls.autoRotateSpeed,i.enablePan=o.controls.enablePan,i.enableZoom=o.controls.enableZoom,i.minPolarAngle=Math.PI/2,i.maxPolarAngle=Math.PI/2,i.minAzimuthAngle=-1/0,i.maxAzimuthAngle=1/0,n.add(new me(16777215,.3));const S=new he(16777215,.5);return S.position.set(5,10,7.5),n.add(S),{scene:n,camera:s,renderer:r,controls:i}},toggleAutoRotate(){k&&(C.value=!C.value,k.autoRotate=C.value,k.autoRotateSpeed=o.controls.autoRotateSpeed,console.log(`自動旋轉狀態已切換為: ${C.value}`))},handleResize(){var t,n;if(!h||!M)return;const e=((t=R.value)==null?void 0:t.clientWidth)??window.innerWidth,a=((n=R.value)==null?void 0:n.clientHeight)??window.innerHeight;h.aspect=e/a,h.updateProjectionMatrix(),M.setSize(e,a)},cleanup(){cancelAnimationFrame(V),window.removeEventListener("resize",w.scene.handleResize),k&&k.dispose(),M&&M.dispose(),A&&(A.dispose(),m!=null&&m.environment&&m.environment.dispose()),l&&(m==null||m.remove(l)),m&&m.traverse(e=>{var a;if(e instanceof le){(a=e.geometry)==null||a.dispose();const t=e.material;Array.isArray(t)?t.forEach(n=>n.dispose()):t&&t.dispose()}}),L&&L.dispose(),R.value&&M&&R.value.removeChild(M.domElement),console.log("Three.js scene cleaned up.")}}};function J(){V=requestAnimationFrame(J),!(!l||!A||!h||!M||!m||!k)&&(w.line.updateMetaball(l),k.update(),M.render(m,h))}function ne(){H.value&&(W.value=!0,P.value=!0,w.flow.initializeState())}return ve(()=>{const{scene:e,camera:a,renderer:t,controls:n}=w.scene.initialize();e&&(m=e,h=a,M=t,k=n,L=new oe(M),L.compileEquirectangularShader(),A=w.material.generate(),l=new ie(200,A,!0,!0,1e5),l.isolation=300,l.scale.set(8,8,8),l.enableUvs=!1,l.enableColors=!1,m.add(l),u=new Se,_=!0,q=null,g="pauseAtStart",w.line.updateMetaball(l),M.render(m,h),Promise.all([new Promise(s=>{w.material.loadEnvironmentMap().then(()=>{console.log("環境貼圖載入完成"),s()}).catch(r=>{console.error("環境貼圖載入失敗:",r),s()})}),new Promise(s=>{fetch("/modelJson.json").then(r=>r.json()).then(r=>{console.log("讀取的設定:",r);const i=r.lineTypes.length;d=new Array(i),f=new Array(i),v=new Array(i),p=new Array(i),E=new Array(i);const S=(u==null?void 0:u.getElapsedTime())??0;for(let c=0;c<i;c++)p[c]=r.lineTypes[c],v[c]=r.currentTargetLengths[c],r.randomDirections[c]?f[c]=new G(r.randomDirections[c].x,r.randomDirections[c].y,r.randomDirections[c].z):f[c]=null,d[c]=S-1e3,E[c]="growing";if(l&&r.cameraQuaternion){const c=new X(r.cameraQuaternion.x,r.cameraQuaternion.y,r.cameraQuaternion.z,r.cameraQuaternion.w);l.quaternion.set(0,0,0,1);const T=c.clone().invert();l.quaternion.premultiply(T),l.matrixWorldNeedsUpdate=!0,l.updateMatrixWorld(!0),l.matrixAutoUpdate=!1}console.log("模型設定已載入完成"),s()}).catch(r=>{console.error("載入模型設定失敗:",r),s()})})]).then(()=>{H.value=!0,console.log("所有資源載入完成，可以開始播放")}),J(),window.addEventListener("resize",w.scene.handleResize))}),ye(()=>{w.scene.cleanup()}),(e,a)=>(j(),K(Te,null,[$("div",xe,[$("div",{ref_key:"canvasContainer",ref:R,class:"canvas-container"},null,512)]),Y(W)?Me("",!0):(j(),K("button",{key:0,class:"control-button",disabled:!Y(H),onClick:ne}," Play ",8,Pe))],64))}};export{De as default};
