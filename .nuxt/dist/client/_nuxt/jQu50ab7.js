import{S as Ge,P as Oe,W as Xe,O as Ye,a as Be,M as He,E as qe,f as Ue,b as fe,j as pe,e as we,g as H,h as q,k as Ve,i as $e}from"./Cx5nvXSb.js";import{r as Ne,Q as j,o as Qe,I as Ze,t as Je,v as Ke,x as je}from"./DcyKddeJ.js";const et={class:"c-splash-component"},ot={__name:"Splash",emits:["stateChange","animationComplete","resourcesLoaded"],setup(tt,{expose:Se,emit:Me}){const U=Me,x=Ne(null),m=j({startStrength:.1,endStrength:.01,minLength:2.5,maxLength:3.5,shrinkPower:.25,numLines:4}),h=j({startStrength:.01,endStrength:.1,minLength:2,maxLength:3,shrinkPower:1.25,numLines:3}),M=j({count:20,minRadius:.35,maxRadius:.5,minLength:3,maxLength:10,segmentDetail:16,minScale:0}),s=j({mobileResolution:100,resolution:100,numSegments:50,subtract:20,growSpeed:.1,growthEaseOutPower:.15,shrinkSpeed:1,shrinkEaseInPower:2.5,flowWaveFrequency:1,flowWaveAmplitudeFactor:.3,flowWaveAmplitudeFactorAtStart:1.5,flowWavePhaseFactor:Math.PI*4});let l=null,L=null,g=null,d=null,u=null,f=null,R=null,W=null,ie=null,V=0,$=0,oe=0,re=0,ee=0,te=0,N=0,Q=0,p=[],P=[],v=[],C=[],A=[],I=[],T=null,k=null,_=null,z=null,a="idle";function Le(){return new pe({color:16777215,metalness:0,roughness:0,transparent:!0,opacity:.75,transmission:1,ior:1.5,thickness:1,envMapIntensity:10,side:we})}function ae(){return new pe({color:16777215,metalness:0,roughness:0,transparent:!0,opacity:.75,transmission:1,ior:1.5,thickness:.1,envMapIntensity:10,side:we})}function Pe(){return new Promise((t,i)=>{new qe().setPath("/hdr/").load("HDR_Light_Studio_Free_HDRI_Design_04.exr",n=>{n.mapping=Ue;const e=W.fromEquirectangular(n).texture;W.dispose(),n.dispose(),console.log("環境貼圖已載入"),l.environment=e,R&&(R.envMap=e,R.needsUpdate=!0),T&&(T.envMap=e,T.needsUpdate=!0),t(e)},void 0,n=>{console.error("無法載入環境貼圖:",n),i(n)})})}function ve(){var e,o;if(!f||!u)return;const t=f.getElapsedTime(),i=m.numLines+h.numLines;p.length=i,P.length=i,v.length=i,C.length=i,A.length=i;let n=0;for(let r=0;r<m.numLines;r++)P[n]||(P[n]=new H),(e=P[n])==null||e.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize(),v[n]=q.randFloat(m.minLength,m.maxLength),C[n]="tt",p[n]=t,a?A[n]=a:A[n]="growing",n++;for(let r=0;r<h.numLines;r++)P[n]||(P[n]=new H),(o=P[n])==null||o.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize(),v[n]=q.randFloat(h.minLength,h.maxLength),C[n]="th",p[n]=t,a?A[n]=a:A[n]="growing",n++;u.reset()}function ke(t){if(!f)return;t.reset();const i=f.getElapsedTime(),n=new H(.5,.5,.5),e=m.numLines+h.numLines;Ee(i);for(let o=0;o<e;o++){if(p[o]===void 0||i<p[o]||v[o]===void 0)continue;const r=v[o]/t.scale.x;let c=0,w=i-p[o];if(a==="pauseAtStart")c=.05;else if(a==="pauseAtEnd")c=r;else if(a==="growing")if(r>.001){const D=s.growSpeed,F=r/D,B=F>0?Math.min(w/F,1):1;c=Math.pow(B,s.growthEaseOutPower)*r}else c=0;else if(a==="shrinking")if(k!==null&&_!==null){const D=_-k,F=i-k,B=Math.min(F/D,1),b=Math.pow(B,s.shrinkEaseInPower),G=Math.max(0,1-b),O=s.growSpeed,J=r/O,he=J>0?Math.min(w/J,1):1;c=Math.pow(he,s.growthEaseOutPower)*r*G}else c=r;else if(r>.001){const D=Math.min(w/(r/s.growSpeed),1);c=Math.pow(D,s.growthEaseOutPower)*r}else c=0;if(c<=.001)continue;const y=P[o],S=C[o];if(!y||!S)continue;let E,Z,Y;S==="tt"?(E=m.startStrength,Z=m.endStrength,Y=m.shrinkPower):(E=h.startStrength,Z=h.endStrength,Y=h.shrinkPower);for(let D=0;D<=s.numSegments;D++){const F=D/s.numSegments,B=Math.pow(F,Y),b=q.lerp(E,Z,B);let G=b,O;if(a==="pauseAtStart")O=s.flowWaveAmplitudeFactorAtStart*b;else if(a==="shrinking"&&c<.1){const ge=Math.max(0,Math.min(1,10*(.1-c))),de=s.flowWaveAmplitudeFactor*b,ze=s.flowWaveAmplitudeFactorAtStart*b;O=de+ge*(ze-de)}else O=s.flowWaveAmplitudeFactor*b;const J=Math.sin(i*s.flowWaveFrequency-F*s.flowWavePhaseFactor)*O;G+=J,G=Math.max(G,0);const K=y.clone().multiplyScalar(c*F).add(n);t.addBall(K.x,K.y,K.z,G,s.subtract)}}t.update()}function Ee(t){if(f)if(a==="growing"&&z!==null){const i=m.numLines+h.numLines;let n=0,e=0;for(let r=0;r<i;r++){if(p[r]===void 0||v[r]===void 0)continue;e++;const c=v[r]/((u==null?void 0:u.scale.x)||1),w=t-(p[r]||t),y=s.growSpeed,S=c/y,E=S>0?Math.min(w/S,1):1;n+=E}(e>0?n/e:0)>=.99&&X("pauseAtEnd")}else a==="shrinking"&&k!==null&&_!==null&&t>=_&&X("pauseAtStart")}function xe(t,i){const n=new Ve(i,M.segmentDetail,M.segmentDetail);T||(T=ae());const e=new fe(n,T);e.position.set(0,0,0);const o={mesh:e,direction:t,targetLength:0,initialScale:i,active:!0,progress:0,currentPosition:0,lastUpdateTime:f?f.getElapsedTime():0,transitionStartTime:null,transitionStartPos:0};return l.add(e),I.push(o),o}function se(){le();for(let t=0;t<M.count;t++){const i=new H(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize(),n=M.minRadius+Math.random()*(M.maxRadius-M.minRadius),e=xe(i,n);e.targetLength=q.randFloat(M.minLength,M.maxLength)}}function le(){for(let t=0;t<I.length;t++){const i=I[t];i.mesh&&(l.remove(i.mesh),i.mesh.geometry.dispose())}I=[]}function Ae(){if(!f)return;const t=f.getElapsedTime();let i=1;if(a==="growing"&&z!==null){const n=m.numLines+h.numLines;let e=0,o=0;for(let r=0;r<n;r++){if(p[r]===void 0||v[r]===void 0)continue;o++;const c=v[r]/((u==null?void 0:u.scale.x)||1),w=t-(p[r]||t),y=s.growSpeed,S=c/y,E=S>0?Math.min(w/S,1):1;e+=E}i=o>0?e/o:1}for(let n=0;n<I.length;n++){const e=I[n];if(!e.active||!e.mesh)continue;let o=0;if(a==="pauseAtStart")o=0;else if(a==="pauseAtEnd")o=e.targetLength;else if(a==="growing"){if(z!==null){e.transitionStartTime!==z&&(e.transitionStartTime=z,e.transitionStartPos=e.currentPosition);const w=Math.pow(i,s.growthEaseOutPower),S=(e.targetLength-e.transitionStartPos)*w;o=e.transitionStartPos+S,i>=.99&&(o=e.targetLength)}}else if(a==="shrinking"&&k!==null&&_!==null){e.transitionStartTime!==k&&(e.transitionStartTime=k,e.transitionStartPos=e.currentPosition);const w=_-k,y=t-k,S=Math.min(y/w,1),E=Math.pow(S,s.shrinkEaseInPower),Y=e.transitionStartPos*E;o=e.transitionStartPos-Y,E>=.99&&(o=0)}o=Math.max(0,Math.min(o,e.targetLength)),e.currentPosition=o,e.progress=e.targetLength>0?o/e.targetLength:0;const r=e.direction.clone().multiplyScalar(o);e.mesh.position.copy(r);let c;if(o<.01)c=M.minScale;else{const w=Math.min(e.progress*1.5,1);c=M.minScale+(e.initialScale-M.minScale)*w}e.mesh.scale.set(c,c,c)}}function ce(){ie=requestAnimationFrame(ce),!(!u||!R||!L||!g||!l||!d)&&(ke(u),Ae(),ee+=(V-ee)*.05,te+=($-te)*.05,l.rotation.x=ee,l.rotation.y=te,l.position.x=oe+N,l.position.y=re+Q,d.update(),g.render(l,L))}function ue(){var n,e;if(!L||!g)return;const t=((n=x.value)==null?void 0:n.clientWidth)??window.innerWidth,i=((e=x.value)==null?void 0:e.clientHeight)??window.innerHeight;L.aspect=t/i,L.updateProjectionMatrix(),g.setSize(t,i)}function Te(){if(!x.value)return console.error("Canvas container not found!"),!1;const t=x.value,i=t.clientWidth,n=t.clientHeight;l=new Ge,l.background=null,L=new Oe(45,i/n,.1,1e3),L.position.set(0,0,30),L.lookAt(l.position),g=new Xe({antialias:!0,alpha:!0}),g.setSize(i,n),g.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),t.appendChild(g.domElement),d=new Ye(L,g.domElement),d.enableDamping=!0,d.enableZoom=!1,d.enablePan=!1,d.enableRotate=!1,d.minDistance=L.position.length(),d.maxDistance=L.position.length(),W=new Be(g),W.compileEquirectangularShader(),R=Le();let e;ne()?(d.autoRotate=!0,d.autoRotateSpeed=1,e=s.mobileResolution):(d.autoRotate=!1,e=s.resolution);const o=e*1.5;return u=new He(e,R,!0,!0,1e5),u.isolation=o,u.scale.set(8,8,8),u.enableUvs=!1,u.enableColors=!1,l.add(u),f=new $e,T=ae(),N=0,Q=0,!0}function ye(){cancelAnimationFrame(ie),window.removeEventListener("resize",ue),N=0,Q=0,le(),d&&d.dispose(),g&&g.dispose(),R&&(R.dispose(),l!=null&&l.environment&&l.environment.dispose()),u&&(l==null||l.remove(u)),l&&l.traverse(t=>{var i;if(t instanceof fe){(i=t.geometry)==null||i.dispose();const n=t.material;Array.isArray(n)?n.forEach(e=>e.dispose()):n&&n.dispose()}}),W&&W.dispose(),x.value&&g&&x.value.removeChild(g.domElement),T&&T.dispose(),console.log("Three.js場景已清理")}function ne(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function De(){a!=="growing"&&a!=="pauseAtEnd"&&(a="growing",be())}function Fe(){a!=="shrinking"&&a!=="pauseAtStart"&&(a="shrinking",Ce())}function Re(){X("pauseAtStart"),ve(),se();const t=m.numLines+h.numLines;for(let i=0;i<t;i++)A[i]!==void 0&&(A[i]="pauseAtStart");console.log("初始化完成：線條收合狀態")}function X(t){a=t,U("stateChange",t),t==="pauseAtEnd"?(console.log("所有線條已生長完成，暫停動畫"),U("animationComplete","growing")):t==="pauseAtStart"&&(console.log("所有線條已收合完成，進入起始暫停狀態"),U("animationComplete","shrinking"))}function be(){var n;if(!f)return;const t=f.getElapsedTime(),i=m.numLines+h.numLines;console.log("所有線條同步生長"),I.length===0&&se(),X("growing"),z=t;for(let e=0;e<i;e++){if(p[e]===void 0)continue;P[e]||(P[e]=new H),(n=P[e])==null||n.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize(),C[e]=e<m.numLines?"tt":"th";const o=C[e]==="tt"?m.minLength:h.minLength,r=C[e]==="tt"?m.maxLength:h.maxLength;v[e]=q.randFloat(o,r),p[e]=t,A[e]="growing"}}function Ce(){if(!f)return;const t=f.getElapsedTime();console.log("所有線條同步收合"),X("shrinking"),k=t,_=t+1/s.shrinkSpeed;const i=m.numLines+h.numLines;for(let n=0;n<i;n++)p[n]!==void 0&&(A[n]="shrinking")}function Ie(){x.value&&(ne()?console.log("行動裝置，不啟用滑鼠控制"):(console.log("啟用桌面滑鼠控制"),window.addEventListener("mousemove",me)))}function _e(){x.value&&window.removeEventListener("mousemove",me)}function me(t){if(ne())return;const i=window.innerWidth/2,n=window.innerHeight/2,e=(t.clientX-i)*.001,o=(t.clientY-n)*.001;oe=e,re=-o,$=(t.clientX/window.innerWidth-.5)*Math.PI*.5,V=(t.clientY/window.innerHeight-.5)*Math.PI*.5,V=Math.max(-Math.PI/4,Math.min(Math.PI/4,V)),$=Math.max(-Math.PI/4,Math.min(Math.PI/4,$)),t.clientX,t.clientY}Qe(()=>{Te()&&(ce(),Pe().then(()=>{console.log("環境貼圖載入完成"),Re(),U("resourcesLoaded",!0)}).catch(t=>{console.error("環境貼圖載入失敗:",t)}),window.addEventListener("resize",ue))}),Ze(()=>{ye(),_e()}),Se({startGrowingAnimation:De,startShrinkingAnimation:Fe,addMouseControlEvents:Ie,updatePositionFromScroll:We});function We(t,i){l&&(N=t,Q=-i,console.log(`更新滾動位移: x=${t}, y=${i}`))}return(t,i)=>(Ke(),Je("div",et,[je("div",{ref_key:"canvasContainer",ref:x,class:"canvas-container"},null,512)]))}};export{ot as _};
