import{a as te,M as ne,b as ae,S as re,P as oe,W as ie,O as se,A as le,D as ce,g as W,Q as ue,h as N,E as de,f as me,j as he,e as pe,i as fe}from"./GFrmpgK8.js";import{r as q,o as ge,I as we,t as V,x as J,N as Se,K as X,O as ve,v as Z}from"./iXxArwze.js";const Me={class:"splash-container"},ke=["disabled"],K=50,$=20,Ee={__name:"ver3",setup(ye){const T=q(null),R=q(!0),L=q(!1),_=q(!1);let u,w,h,y,l,c,S,D,U,p=[],P=[],b=[],x=[],z=[],f=null,v=null,O=null,I=!1,d="idle",F=null;const o={centerBall:{maxStrength:1,minStrength:0,fadeDuration:5,fadeEasing:{type:"easeIn",power:.5}},timing:{baseShrinkDuration:3,flowShrinkDurationFactor:.2},growth:{speed:5,easeOutPower:.15,flowSpeedFactor:.1},wave:{frequency:1,amplitudeFactor:.3,phaseFactor:Math.PI*4},renderer:{pixelRatio:1.5,antialias:!0,alpha:!0},camera:{fov:45,near:.1,far:1e3,position:{x:0,y:0,z:25}},controls:{enableDamping:!0,autoRotateSpeed:5,enablePan:!1,enableZoom:!1}},m={material:{generate(){return new he({color:16777215,metalness:0,roughness:0,transparent:!0,opacity:.75,transmission:1,ior:1.33,thickness:1,envMap:null,envMapIntensity:50,side:pe})},loadEnvironmentMap(){return new Promise((t,r)=>{new de().setPath("/hdr/").load("HDR_Light_Studio_Free_HDRI_Design_04.exr",e=>{e.mapping=me;const n=D.fromEquirectangular(e).texture;D.dispose(),e.dispose(),console.log("本地 EXR 環境貼圖已載入並處理完成。"),u.environment=n,S&&(S.envMap=n,S.needsUpdate=!0),t(n)},void 0,e=>{console.error("無法載入本地 EXR 環境貼圖:",e),r(e)})})}},line:{updateMetaball(t){if(!c)return;t.reset();const r=c.getElapsedTime(),e=new W(.5,.5,.5),n=x.length;if(m.flow.updateGlobalState(r),I){const s=m.ball.calculateCenterStrength(r);s>.01&&t.addBall(e.x,e.y,e.z,s,$)}if(!_.value){t.update();return}for(let s=0;s<n;s++){if(p[s]===void 0||r<p[s]||b[s]===void 0)continue;const a=b[s]/t.scale.x;let i=0,g=r-p[s];switch(d){case"growing":if(a>.001){const k=o.growth.speed*o.growth.flowSpeedFactor,E=a/(k/t.scale.x),B=E>0?Math.min(g/E,1):1;i=Math.pow(B,o.growth.easeOutPower)*a}else i=0;break;case"pauseAtEnd":i=a;break;case"shrinking":if(f!==null&&v!==null){const k=v-f,E=r-f,B=Math.min(E/k,1),C=Math.max(0,1-B);i=a*C}else i=a;break;case"pauseAtStart":i=.001;break;default:i=0;break}if(z[s]=d,i<=.001)continue;const A=P[s],M=x[s];if(!(!A||!M))for(let k=0;k<=K;k++){const E=k/K,B=Math.pow(E,M==="tt"?.25:1.25),C=N.lerp(M==="tt"?.1:.01,M==="tt"?.01:.1,B);let G=C;const j=o.wave.amplitudeFactor*C,ee=Math.sin(r*o.wave.frequency-E*o.wave.phaseFactor)*j;G+=ee,G=Math.max(G,0);const Q=A.clone().multiplyScalar(i*E).add(e);t.addBall(Q.x,Q.y,Q.z,G,$)}}t.update()},loadModelJson(){return new Promise((t,r)=>{fetch("/modelJson.json").then(e=>e.json()).then(e=>{console.log("讀取的設定:",e);const n=e.lineTypes.length;p=new Array(n),P=new Array(n),b=new Array(n),x=new Array(n),z=new Array(n);const s=(c==null?void 0:c.getElapsedTime())??0;for(let a=0;a<n;a++)x[a]=e.lineTypes[a],b[a]=e.currentTargetLengths[a],e.randomDirections[a]?P[a]=new W(e.randomDirections[a].x,e.randomDirections[a].y,e.randomDirections[a].z):P[a]=null,p[a]=s-1e3,z[a]="growing";if(l&&e.cameraQuaternion){const a=new ue(e.cameraQuaternion.x,e.cameraQuaternion.y,e.cameraQuaternion.z,e.cameraQuaternion.w);l.quaternion.set(0,0,0,1);const i=a.clone().invert();l.quaternion.premultiply(i),l.matrixWorldNeedsUpdate=!0,l.updateMatrixWorld(!0),l.matrixAutoUpdate=!1}console.log("模型設定已載入完成"),t()}).catch(e=>{console.error("載入模型設定失敗:",e),r(e)})})}},ball:{calculateCenterStrength(t){if(!c||(t===void 0&&(t=c.getElapsedTime()),!_.value))return .5;if(d==="shrinking"){if(f===null||v===null)return 0;const r=v-f,e=t-f,n=Math.min(e/r,1);return o.centerBall.minStrength+n*(o.centerBall.maxStrength-o.centerBall.minStrength)}else if(d==="pauseAtStart"){if(F===null)return F=t,o.centerBall.maxStrength;const r=t-F,e=Math.min(r/o.centerBall.fadeDuration,1);let n;switch(o.centerBall.fadeEasing.type){case"easeIn":n=Math.pow(e,o.centerBall.fadeEasing.power);break;case"easeOut":n=1-Math.pow(1-e,o.centerBall.fadeEasing.power);break;case"linear":default:n=e;break}return o.centerBall.maxStrength*(1-n)}else return o.centerBall.minStrength}},flow:{calculateCurrentLength(t,r,e,n,s){switch(t){case"growing":if(r>.001){const a=o.growth.speed*o.growth.flowSpeedFactor,i=r/(a/n),g=i>0?Math.min(e/i,1):1;return Math.pow(g,o.growth.easeOutPower)*r}return 0;case"pauseAtEnd":return r;case"shrinking":if(f!==null&&v!==null){const a=c.getElapsedTime(),i=v-f,g=a-f,A=Math.min(g/i,1),M=Math.max(0,1-A);return r*M}return r;case"pauseAtStart":return .001;default:return 0}},updateGlobalState(t){if(c)if(d==="growing"&&O!==null){const r=x.length;let e=0,n=0;for(let a=0;a<r;a++){if(p[a]===void 0||b[a]===void 0)continue;n++;const i=b[a]/((l==null?void 0:l.scale.x)||1),g=t-(p[a]||t),A=o.growth.speed*o.growth.flowSpeedFactor,M=i/(A/((l==null?void 0:l.scale.x)||1)),k=M>0?Math.min(g/M,1):1;e+=k}(n>0?e/n:0)>=.99&&(d="pauseAtEnd",console.log("所有線條已生長完成，進入暫停狀態"),setTimeout(()=>{this.startShrinking()},1e3))}else d==="shrinking"&&f!==null&&v!==null&&t>=v&&(d="pauseAtStart",console.log("所有線條已收合完成，進入起始暫停狀態"),setTimeout(()=>{this.startGrowing()},1e3))},startShrinking(){if(!c)return;const t=c.getElapsedTime();console.log("所有線條同步收合"),d="shrinking",f=t,v=t+o.timing.baseShrinkDuration*o.timing.flowShrinkDurationFactor,I=!0},startGrowing(){var e;if(!c)return;const t=c.getElapsedTime(),r=x.length;console.log("所有線條同步生長"),d="growing",O=t,I=!1,F=null;for(let n=0;n<r;n++){if(p[n]===void 0)continue;P[n]||(P[n]=new W),(e=P[n])==null||e.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize();const s=2,a=3.5;b[n]=N.randFloat(s,a),p[n]=t}},initializeState(){if(!c)return;console.log("初始化流動動畫狀態...");const t=c.getElapsedTime();[...x],P.map(e=>e?{x:e.x,y:e.y,z:e.z}:null),[...b],[...p],w.position.clone(),w.quaternion.clone(),d="growing",O=t;const r=x.length;z.length=r;for(let e=0;e<r;e++)p[e]=t,z[e]="growing";l.reset(),l.material=S,console.log("流動動畫已初始化完成")}},scene:{initialize(){if(!T.value)return console.error("Canvas container not found!"),null;const t=T.value,r=t.clientWidth,e=t.clientHeight,n=new re;n.background=null;const s=new oe(o.camera.fov,r/e,o.camera.near,o.camera.far);s.position.set(o.camera.position.x,o.camera.position.y,o.camera.position.z),s.lookAt(0,0,0);const a=new ie({antialias:o.renderer.antialias,alpha:o.renderer.alpha});a.setSize(r,e),a.setPixelRatio(Math.min(window.devicePixelRatio,o.renderer.pixelRatio)),t.appendChild(a.domElement);const i=new se(s,a.domElement);i.enableDamping=o.controls.enableDamping,i.autoRotate=R.value,i.autoRotateSpeed=o.controls.autoRotateSpeed,i.enablePan=o.controls.enablePan,i.enableZoom=o.controls.enableZoom,i.minPolarAngle=Math.PI/2,i.maxPolarAngle=Math.PI/2,i.minAzimuthAngle=-1/0,i.maxAzimuthAngle=1/0,n.add(new le(16777215,.3));const g=new ce(16777215,.5);return g.position.set(5,10,7.5),n.add(g),{scene:n,camera:s,renderer:a,controls:i}},toggleAutoRotate(){y&&(R.value=!R.value,y.autoRotate=R.value,y.autoRotateSpeed=o.controls.autoRotateSpeed,console.log(`自動旋轉狀態已切換為: ${R.value}`))},handleResize(){var e,n;if(!w||!h)return;const t=((e=T.value)==null?void 0:e.clientWidth)??window.innerWidth,r=((n=T.value)==null?void 0:n.clientHeight)??window.innerHeight;w.aspect=t/r,w.updateProjectionMatrix(),h.setSize(t,r)},cleanup(){cancelAnimationFrame(U),window.removeEventListener("resize",m.scene.handleResize),y&&y.dispose(),h&&h.dispose(),S&&(S.dispose(),u!=null&&u.environment&&u.environment.dispose()),l&&(u==null||u.remove(l)),u&&u.traverse(t=>{var r;if(t instanceof ae){(r=t.geometry)==null||r.dispose();const e=t.material;Array.isArray(e)?e.forEach(n=>n.dispose()):e&&e.dispose()}}),D&&D.dispose(),T.value&&h&&T.value.removeChild(h.domElement),console.log("Three.js scene cleaned up.")}}};function H(){U=requestAnimationFrame(H),!(!l||!S||!w||!h||!u||!y)&&(m.line.updateMetaball(l),y.update(),h.render(u,w))}function Y(){L.value&&(_.value=!0,m.flow.initializeState())}return ge(()=>{const{scene:t,camera:r,renderer:e,controls:n}=m.scene.initialize();t&&(u=t,w=r,h=e,y=n,D=new te(h),D.compileEquirectangularShader(),S=m.material.generate(),l=new ne(200,S,!0,!0,1e5),l.isolation=300,l.scale.set(8,8,8),l.enableUvs=!1,l.enableColors=!1,u.add(l),c=new fe,I=!0,F=null,d="pauseAtStart",m.line.updateMetaball(l),h.render(u,w),Promise.all([m.material.loadEnvironmentMap(),m.line.loadModelJson()]).then(()=>{L.value=!0,console.log("所有資源載入完成，可以開始播放")}).catch(s=>{console.error("資源載入過程中發生錯誤:",s),L.value=!0,console.log("嘗試啟用播放按鈕，但部分資源可能未完全載入")}),H(),window.addEventListener("resize",m.scene.handleResize))}),we(()=>{m.scene.cleanup()}),(t,r)=>(Z(),V(ve,null,[J("div",Me,[J("div",{ref_key:"canvasContainer",ref:T,class:"canvas-container"},null,512)]),X(_)?Se("",!0):(Z(),V("button",{key:0,class:"control-button",disabled:!X(L),onClick:Y}," Play ",8,ke))],64))}};export{Ee as default};
