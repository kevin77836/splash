import{i as N,S as V,P as K,W as X,O as J,a as Q,M as Y,E as Z,f as $,b as j,j as ee,e as te,g as _,h as E}from"./GFrmpgK8.js";import{r as p,o as ne,I as re,t as se,x as R,y as ae,K as A,v as ie}from"./B_MDMm1d.js";const oe={class:"splash-container"},le=["disabled"],de={__name:"generate-3",setup(ce){const v=p(!0),w=p("Play"),d=p("stopped"),i={scene:{scale:8,pixelRatio:1.5},metaball:{resolution:200,segments:50,subtract:20,maxBalls:1e5},material:{color:16777215,metalness:0,roughness:0,opacity:.75,transmission:1,ior:1.33,thickness:1,envMapIntensity:300},lines:{thickToThin:{startStrength:.1,endStrength:.01,minLength:2.5,maxLength:3.5,shrinkPower:.25,count:4},thinToThick:{startStrength:.01,endStrength:.1,minLength:2,maxLength:3,shrinkPower:1.25,count:3}},controls:{autoRotate:!0,rotateSpeed:2,enableDamping:!0},animation:{growthSpeed:5}},h=p(null),C=p(null),e={scene:null,camera:null,renderer:null,controls:null,effect:null,material:null,pmremGenerator:null,animationId:null,clock:null,lines:{directions:[],lengths:[],types:[],startTimes:[],targetProgress:[],currentProgress:[]},dispose(){var n,r;cancelAnimationFrame(this.animationId),this.controls&&this.controls.dispose(),this.renderer&&this.renderer.dispose(),this.material&&(this.material.dispose(),(n=this.scene)!=null&&n.environment&&this.scene.environment.dispose()),this.effect&&((r=this.scene)==null||r.remove(this.effect)),this.scene&&this.scene.traverse(t=>{var s;t instanceof j&&((s=t.geometry)==null||s.dispose(),Array.isArray(t.material)?t.material.forEach(o=>o.dispose()):t.material&&t.material.dispose())}),this.pmremGenerator&&this.pmremGenerator.dispose(),h.value&&this.renderer&&h.value.removeChild(this.renderer.domElement)}};function G(){d.value==="stopped"||d.value==="returning"?(d.value="playing",w.value="Return",T(1)):(d.value="returning",w.value="Play",T(0)),I(),D()}function T(n){const{targetProgress:r}=e.lines,t=r.length;for(let s=0;s<t;s++)r[s]=n}function I(){if(!e.clock)return;const{currentProgress:n}=e.lines;n.length}function D(){if(!e.clock)return;const n=e.clock.getElapsedTime(),{startTimes:r}=e.lines,t=r.length;for(let s=0;s<t;s++)r[s]=n}function B(){return new ee({color:i.material.color,metalness:i.material.metalness,roughness:i.material.roughness,transparent:!0,opacity:i.material.opacity,side:te,transmission:i.material.transmission,ior:i.material.ior,thickness:i.material.thickness,envMapIntensity:i.material.envMapIntensity})}function z(){return new Promise((n,r)=>{new Z().setPath("/hdr/").load("HDR_Light_Studio_Free_HDRI_Design_04.exr",t=>{t.mapping=$;const s=e.pmremGenerator.fromEquirectangular(t).texture;e.pmremGenerator.dispose(),t.dispose(),e.scene.environment=s,e.material&&(e.material.envMap=s,e.material.needsUpdate=!0),n(s)},void 0,t=>{console.error("無法載入環境貼圖:",t),r(t)})})}function F(){const{thickToThin:n,thinToThick:r}=i.lines,t=n.count+r.count,s=e.clock.getElapsedTime();e.lines.directions=new Array(t),e.lines.lengths=new Array(t),e.lines.types=new Array(t),e.lines.startTimes=new Array(t).fill(s),e.lines.targetProgress=new Array(t).fill(0),e.lines.currentProgress=new Array(t).fill(0);let o=0;const l=(c,a)=>{const m=new _(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize(),u=E.randFloat(c.minLength,c.maxLength);e.lines.directions[o]=m,e.lines.lengths[o]=u,e.lines.types[o]=a,o++};for(let c=0;c<n.count;c++)l(n,"tt");for(let c=0;c<r.count;c++)l(r,"th");e.effect&&L(),d.value="stopped",w.value="Play"}function H(){if(!e.clock||d.value==="stopped")return!1;const n=e.clock.getElapsedTime();let r=!1;const{startTimes:t,lengths:s,targetProgress:o,currentProgress:l}=e.lines,c=t.length;for(let a=0;a<c;a++){const m=o[a]>l[a],u=o[a]<l[a];if(!m&&!u||m&&l[a]>=o[a]||u&&l[a]<=o[a])continue;const y=n-t[a],f=s[a];if(f>.001){const g=i.animation.growthSpeed/f*y,M=l[a];m?l[a]=Math.min(l[a]+g,o[a]):u&&(l[a]=Math.max(l[a]-g,o[a])),Math.abs(l[a]-M)>.001&&(r=!0,t[a]=n)}}return U(),r}function U(){const{targetProgress:n,currentProgress:r}=e.lines,t=r.length;let s=!0;for(let o=0;o<t;o++)if(Math.abs(r[o]-n[o])>.01){s=!1;break}s&&d.value==="returning"&&(d.value="stopped")}function L(){const n=e.effect;if(!n)return;n.reset();const r=new _(.5,.5,.5),{directions:t,lengths:s,types:o,currentProgress:l}=e.lines,c=o.length;for(let a=0;a<c;a++){if(!s[a])continue;const m=s[a]/n.scale.x,u=m*l[a];if(u<=.001)continue;const y=t[a],f=o[a];if(!y||!f)continue;const P=f==="tt"?i.lines.thickToThin:i.lines.thinToThick;for(let k=0;k<=i.metaball.segments;k++){const g=k/i.metaball.segments;if(g*m>u)continue;const M=u>0?g*m/u:0,q=Math.pow(M,P.shrinkPower),O=E.lerp(P.startStrength,P.endStrength,q),S=y.clone().multiplyScalar(u*M).add(r);n.addBall(S.x,S.y,S.z,O,i.metaball.subtract)}}n.update()}function b(){var t,s;if(!e.camera||!e.renderer)return;const n=((t=h.value)==null?void 0:t.clientWidth)??window.innerWidth,r=((s=h.value)==null?void 0:s.clientHeight)??window.innerHeight;e.camera.aspect=n/r,e.camera.updateProjectionMatrix(),e.renderer.setSize(n,r)}function W(){if(!h.value)return console.error("找不到畫布容器!"),!1;const n=h.value,r=n.clientWidth||window.innerWidth,t=n.clientHeight||window.innerHeight;e.clock=new N,e.scene=new V,e.scene.background=null,e.camera=new K(45,r/t,.1,1e3),e.camera.position.set(0,0,30),e.camera.lookAt(0,0,0),e.renderer=new X({antialias:!0,alpha:!0}),e.renderer.setSize(r,t),e.renderer.setPixelRatio(Math.min(window.devicePixelRatio,i.scene.pixelRatio)),n.appendChild(e.renderer.domElement),e.controls=new J(e.camera,e.renderer.domElement),e.controls.enableDamping=i.controls.enableDamping,e.controls.autoRotate=i.controls.autoRotate,e.controls.autoRotateSpeed=i.controls.rotateSpeed,e.pmremGenerator=new Q(e.renderer),e.pmremGenerator.compileEquirectangularShader(),e.material=B();const s=i.metaball.resolution*1.5;return e.effect=new Y(i.metaball.resolution,e.material,!0,!0,i.metaball.maxBalls),e.effect.isolation=s,e.effect.scale.set(i.scene.scale,i.scene.scale,i.scene.scale),e.effect.enableUvs=!1,e.effect.enableColors=!1,e.scene.add(e.effect),!0}function x(){const{camera:n,renderer:r,scene:t,controls:s,effect:o}=e;if(!o||!n||!r||!t||!s)return;s.update(),H()&&L(),r.render(t,n),e.animationId=requestAnimationFrame(x)}return ne(async()=>{if(W())try{v.value=!0,await z(),F(),x(),window.addEventListener("resize",b),v.value=!1}catch(n){console.error("初始化失敗:",n),v.value=!1}}),re(()=>{e.dispose(),window.removeEventListener("resize",b)}),(n,r)=>(ie(),se("div",oe,[R("div",{ref_key:"canvasContainer",ref:h,class:"splash-canvas"},null,512),R("button",{ref_key:"controlButton",ref:C,class:"control-button",disabled:A(v),onClick:G},ae(A(w)),9,le)]))}};export{de as default};
